# ğŸ§ª Testes UnitÃ¡rios - Sistema de Armazenamento de Fotos

## ğŸ“‹ VisÃ£o Geral

Testes unitÃ¡rios criados com **JUnit 5** e **Mockito** para validar a funcionalidade core do sistema de armazenamento de fotos.

## ğŸ¯ Cobertura de Testes

### 1. UserPhotoServiceTest
Testa a lÃ³gica de negÃ³cio para operaÃ§Ãµes de fotos por usuÃ¡rio.

**CenÃ¡rios Testados:**
- âœ… Upload de foto com nome automÃ¡tico (UUID)
- âœ… Upload de foto com nome especÃ­fico
- âœ… Upload de avatar
- âœ… Obter URL do avatar (quando existe e quando nÃ£o existe)
- âœ… Listar fotos do usuÃ¡rio
- âœ… Verificar se usuÃ¡rio tem avatar
- âœ… Verificar se foto especÃ­fica existe
- âœ… Contar fotos do usuÃ¡rio
- âœ… Obter URL de foto especÃ­fica
- âœ… Obter URLs de todas as fotos

**Total: 13 testes**

### 2. UserPhotoControllerTest
Testa os endpoints REST para operaÃ§Ãµes de fotos por usuÃ¡rio.

**CenÃ¡rios Testados:**
- âœ… Upload de foto com arquivo vÃ¡lido
- âœ… Upload de foto com arquivo vazio (erro)
- âœ… Upload de avatar
- âœ… Download de foto do usuÃ¡rio
- âœ… Obter URL prÃ©-assinada (quando existe e quando nÃ£o existe)
- âœ… Listar fotos do usuÃ¡rio
- âœ… Verificar existÃªncia de foto
- âœ… Obter informaÃ§Ãµes da foto (quando existe e quando nÃ£o existe)
- âœ… Obter URLs de todas as fotos

**Total: 12 testes**

### 3. PhotoControllerTest
Testa os endpoints REST gerais para operaÃ§Ãµes de fotos.

**CenÃ¡rios Testados:**
- âœ… Upload de foto com arquivo vÃ¡lido
- âœ… Upload de foto com arquivo vazio (erro)
- âœ… Upload sem nome especÃ­fico (usa nome original)
- âœ… Download de foto
- âœ… Obter URL prÃ©-assinada
- âœ… Obter URL com tempo de expiraÃ§Ã£o padrÃ£o
- âœ… Listar fotos sem prefixo
- âœ… Listar fotos com prefixo
- âœ… Verificar existÃªncia de foto
- âœ… Obter informaÃ§Ãµes da foto

**Total: 10 testes**

## ğŸ“Š EstatÃ­sticas

- **Total de Testes**: 35
- **Framework**: JUnit 5 + Mockito
- **Tipo**: Testes UnitÃ¡rios
- **Cobertura**: Funcionalidades Core

## ğŸš€ Executar os Testes

### Executar Todos os Testes
```bash
./gradlew test
```

### Executar Testes EspecÃ­ficos
```bash
# Apenas UserPhotoServiceTest
./gradlew test --tests UserPhotoServiceTest

# Apenas Controllers
./gradlew test --tests "*ControllerTest"

# Apenas Services
./gradlew test --tests "*ServiceTest"
```

### Executar com RelatÃ³rio de Cobertura
```bash
./gradlew test jacocoTestReport
```

O relatÃ³rio serÃ¡ gerado em: `build/reports/jacoco/test/html/index.html`

## ğŸ” Estrutura dos Testes

### PadrÃ£o AAA (Arrange-Act-Assert)

Todos os testes seguem o padrÃ£o AAA:

```java
@Test
void uploadUserPhoto_WithAutoGeneratedName_ShouldUploadSuccessfully() throws IOException {
    // Arrange - Preparar dados e mocks
    when(mockFile.getBytes()).thenReturn(PHOTO_DATA);
    when(storageService.uploadPhoto(...)).thenReturn("users/123/uuid.jpg");

    // Act - Executar a aÃ§Ã£o
    String result = userPhotoService.uploadUserPhoto(USER_ID, mockFile);

    // Assert - Verificar resultados
    assertNotNull(result);
    assertTrue(result.endsWith(".jpg"));
    verify(storageService).uploadPhoto(...);
}
```

### Uso de Mocks

Os testes usam mocks para isolar as dependÃªncias:

```java
@Mock
private StorageService storageService;  // Mock da dependÃªncia

@InjectMocks
private UserPhotoService userPhotoService;  // Classe sendo testada
```

## ğŸ“ Exemplos de Testes

### Teste de Service

```java
@Test
void uploadUserAvatar_ShouldUploadWithAvatarName() throws IOException {
    // Arrange
    when(mockFile.getBytes()).thenReturn(PHOTO_DATA);
    when(storageService.uploadPhoto(anyString(), any(byte[].class), eq(CONTENT_TYPE)))
            .thenReturn("users/123/avatar.jpg");

    // Act
    String result = userPhotoService.uploadUserAvatar(USER_ID, mockFile);

    // Assert
    assertEquals("users/123/avatar.jpg", result);
    verify(storageService).uploadPhoto(
            eq("users/123/avatar.jpg"),
            eq(PHOTO_DATA),
            eq(CONTENT_TYPE)
    );
}
```

### Teste de Controller

```java
@Test
void uploadUserPhoto_WithValidFile_ShouldReturnCreated() throws Exception {
    // Arrange
    MockMultipartFile file = new MockMultipartFile(
            "file",
            "test.jpg",
            MediaType.IMAGE_JPEG_VALUE,
            "test-data".getBytes()
    );

    when(storageService.uploadPhoto(anyString(), any(byte[].class), anyString()))
            .thenReturn("users/123/test.jpg");

    // Act & Assert
    mockMvc.perform(multipart(BASE_URL)
                    .file(file)
                    .param("photoName", "test.jpg"))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.message").value("Foto enviada com sucesso"))
            .andExpect(jsonPath("$.userId").value(USER_ID));
}
```

## ğŸ¯ Boas PrÃ¡ticas Implementadas

### 1. Isolamento de Testes
- Cada teste Ã© independente
- Uso de mocks para dependÃªncias externas
- NÃ£o hÃ¡ dependÃªncia de banco de dados ou storage real

### 2. Nomenclatura Clara
```java
// PadrÃ£o: metodo_cenario_resultadoEsperado
uploadUserPhoto_WithValidFile_ShouldReturnCreated()
getUserAvatarUrl_WhenAvatarDoesNotExist_ShouldReturnNull()
```

### 3. Testes de Casos de Erro
```java
@Test
void uploadUserPhoto_WithEmptyFile_ShouldReturnBadRequest()

@Test
void getUserPhotoUrl_WhenPhotoDoesNotExist_ShouldReturnNull()
```

### 4. VerificaÃ§Ã£o de Comportamento
```java
// Verifica que o mÃ©todo foi chamado com os parÃ¢metros corretos
verify(storageService).uploadPhoto(
    eq("users/123/photo.jpg"),
    eq(PHOTO_DATA),
    eq(CONTENT_TYPE)
);

// Verifica que o mÃ©todo NÃƒO foi chamado
verify(storageService, never()).uploadPhoto(anyString(), any(), anyString());
```

## ğŸ”§ ConfiguraÃ§Ã£o do Projeto

### DependÃªncias NecessÃ¡rias (build.gradle)

```gradle
dependencies {
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}
```

O Spring Boot Starter Test jÃ¡ inclui:
- JUnit 5
- Mockito
- AssertJ
- Hamcrest
- MockMvc

## ğŸ“ˆ PrÃ³ximos Passos

### Testes de IntegraÃ§Ã£o
Criar testes de integraÃ§Ã£o que validem:
- IntegraÃ§Ã£o real com MinIO/S3
- Fluxo completo de upload e download
- PersistÃªncia de dados

### Testes de Performance
- Teste de upload de mÃºltiplos arquivos
- Teste de listagem com muitos arquivos
- Teste de concorrÃªncia

### Testes End-to-End
- Fluxo completo do usuÃ¡rio
- ValidaÃ§Ã£o de URLs geradas
- ExpiraÃ§Ã£o de URLs prÃ©-assinadas

## ğŸ› Troubleshooting

### Erro: "Cannot find symbol MockMvc"
Certifique-se de ter a dependÃªncia `spring-boot-starter-test`

### Erro: "No tests found"
Verifique se as classes de teste estÃ£o no diretÃ³rio `src/test/java`

### Erro: Java version
O projeto requer Java 21. Configure o JAVA_HOME:
```bash
export JAVA_HOME=/path/to/java-21
```

## ğŸ“š Recursos

- [JUnit 5 Documentation](https://junit.org/junit5/docs/current/user-guide/)
- [Mockito Documentation](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- [Spring Boot Testing](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing)
- [MockMvc Documentation](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/servlet/MockMvc.html)